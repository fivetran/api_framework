<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Fivetran Services - Connection State Manager</title>
    <link
      rel="icon"
      type="image/x-icon"
      href="https://dbos-blog-posts.s3.us-west-1.amazonaws.com/live-demo/favicon.ico"
    />
    <script src="https://cdn.tailwindcss.com"></script>
    <script
      defer
      src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"
    ></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              fivetran: {
                blue: '#306BEA',
                'blue-dark': '#2554B8',
                'blue-light': '#5A8AFF',
              }
            },
            animation: {
              'fade-in': 'fadeIn 0.5s ease-in-out',
              'slide-up': 'slideUp 0.3s ease-out',
              'pulse-slow': 'pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite',
            },
            keyframes: {
              fadeIn: {
                '0%': { opacity: '0' },
                '100%': { opacity: '1' }
              },
              slideUp: {
                '0%': { transform: 'translateY(10px)', opacity: '0' },
                '100%': { transform: 'translateY(0)', opacity: '1' }
              }
            }
          }
        }
      }
    </script>
    <style>
      @keyframes rotation {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }

      .spinner {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        display: inline-block;
        border-top: 2px solid #fff;
        border-right: 2px solid transparent;
        box-sizing: border-box;
        animation: rotation 1s linear infinite;
      }

      .card-hover {
        transition: all 0.3s ease;
      }

      .card-hover:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
      }

      .input-focus:focus {
        outline: none;
        ring: 2px;
        ring-color: #306BEA;
        border-color: #306BEA;
      }

      .obfuscated-text {
        font-family: 'Courier New', monospace;
        letter-spacing: 2px;
        color: #64748b;
      }

      .json-viewer {
        background: #1e293b;
        color: #e2e8f0;
        font-family: 'Courier New', monospace;
        font-size: 0.875rem;
        line-height: 1.5;
        max-height: 400px;
        overflow-y: auto;
      }

      .json-viewer::-webkit-scrollbar {
        width: 8px;
      }

      .json-viewer::-webkit-scrollbar-track {
        background: #0f172a;
      }

      .json-viewer::-webkit-scrollbar-thumb {
        background: #475569;
        border-radius: 4px;
      }

      .json-viewer::-webkit-scrollbar-thumb:hover {
        background: #64748b;
      }
    </style>
  </head>
  <body
    x-data="fivetranStateManager()"
    class="min-h-screen bg-white font-sans"
  >
    <!-- Connection Status Alert -->
    <div
      x-show="connectionError"
      x-transition:enter="transition ease-out duration-300"
      x-transition:enter-start="opacity-0 transform -translate-y-2"
      x-transition:enter-end="opacity-100 transform translate-y-0"
      class="fixed top-4 left-4 right-4 z-50 flex justify-center items-center text-center bg-red-500 text-white p-4 rounded-lg shadow-lg"
    >
      <div class="flex items-center space-x-3">
        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
        </svg>
        <span x-text="connectionError"></span>
        <button @click="connectionError = ''" class="ml-4 hover:bg-red-600 rounded px-2 py-1">
          <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
          </svg>
        </button>
      </div>
    </div>

    <!-- Success Message -->
    <div
      x-show="successMessage"
      x-transition:enter="transition ease-out duration-300"
      x-transition:enter-start="opacity-0 transform -translate-y-2"
      x-transition:enter-end="opacity-100 transform translate-y-0"
      class="fixed top-4 left-4 right-4 z-50 flex justify-center items-center text-center bg-green-500 text-white p-4 rounded-lg shadow-lg"
    >
      <div class="flex items-center space-x-3">
        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
        </svg>
        <span x-text="successMessage"></span>
        <button @click="successMessage = ''" class="ml-4 hover:bg-green-600 rounded px-2 py-1">
          <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
          </svg>
        </button>
      </div>
    </div>

    <!-- Header -->
    <header class="bg-white shadow-sm border-b border-gray-200">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between items-center py-4">
          <div class="flex items-center space-x-4">
            <div class="w-10 h-10 rounded-lg flex items-center justify-center" style="background-color: #306BEA;">
              <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
              </svg>
            </div>
            <div>
              <h1 class="text-2xl font-bold" style="color: #306BEA;">Fivetran AI Services - Connection State Manager</h1>
              <p class="text-sm text-gray-500">Manage connection state with DBOS reliability</p>
            </div>
          </div>
          <div class="flex items-center space-x-2">
            <div x-show="credentialsSaved" class="flex items-center space-x-2 text-sm" style="color: #306BEA;">
              <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
              </svg>
              <span>Credentials Saved</span>
            </div>
            <img
              src="https://dbos-blog-posts.s3.us-west-1.amazonaws.com/logos/black_logotype%2Btransparent_bg_h4000px.png"
              alt="DBOS Logo"
              class="h-8 opacity-70"
            />
          </div>
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        <!-- Compact Credentials Section -->
        <div class="mb-6">
          <div class="bg-white rounded-lg shadow-md border border-gray-200 overflow-hidden">
            <div 
              @click="credentialsExpanded = !credentialsExpanded"
              class="px-4 py-3 cursor-pointer hover:bg-gray-50 transition-colors flex items-center justify-between"
              style="background-color: #306BEA;"
            >
              <div class="flex items-center space-x-3">
                <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                </svg>
                <h2 class="text-lg font-semibold text-white">API Credentials</h2>
                <div x-show="credentialsSaved" class="flex items-center space-x-2 text-sm text-white opacity-90">
                  <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                  </svg>
                  <span>Saved</span>
                </div>
              </div>
              <svg 
                class="w-5 h-5 text-white transition-transform" 
                :class="credentialsExpanded ? 'rotate-180' : ''"
                fill="none" 
                stroke="currentColor" 
                viewBox="0 0 24 24"
              >
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
              </svg>
            </div>
            
            <div 
              x-show="credentialsExpanded || !credentialsSaved"
              x-transition:enter="transition ease-out duration-200"
              x-transition:enter-start="opacity-0 max-h-0"
              x-transition:enter-end="opacity-100 max-h-96"
              class="p-4 space-y-3"
            >
              <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                <div>
                  <label class="block text-xs font-medium text-gray-700 mb-1">
                    Fivetran API Key
                  </label>
                  <div class="relative">
                    <input
                      type="password"
                      x-model="apiKey"
                      placeholder="Enter API key"
                      class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 transition-colors input-focus"
                      :class="credentialsSaved && apiKey ? 'bg-gray-50' : ''"
                    />
                    <div x-show="credentialsSaved && apiKey" class="absolute right-2 top-2">
                      <svg class="w-4 h-4" style="color: #306BEA;" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                      </svg>
                    </div>
                  </div>
                </div>

                <div>
                  <label class="block text-xs font-medium text-gray-700 mb-1">
                    Fivetran API Secret
                  </label>
                  <div class="relative">
                    <input
                      type="password"
                      x-model="apiSecret"
                      placeholder="Enter API secret"
                      class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 transition-colors input-focus"
                      :class="credentialsSaved && apiSecret ? 'bg-gray-50' : ''"
                    />
                    <div x-show="credentialsSaved && apiSecret" class="absolute right-2 top-2">
                      <svg class="w-4 h-4" style="color: #306BEA;" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                      </svg>
                    </div>
                  </div>
                </div>
              </div>

              <div class="flex items-center space-x-2">
                <button
                  @click="saveCredentials()"
                  :disabled="!apiKey || !apiSecret || loading"
                  class="px-4 py-2 text-sm font-medium text-white rounded-lg transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed flex items-center hover:opacity-90"
                  :style="(!apiKey || !apiSecret || loading) ? 'background-color: #9CA3AF;' : 'background-color: #306BEA;'"
                >
                  <span x-show="!loading">Save</span>
                  <span x-show="loading" class="flex items-center space-x-2">
                    <span class="spinner"></span>
                    <span>Saving...</span>
                  </span>
                </button>
                <button
                  x-show="credentialsSaved"
                  @click="clearCredentials()"
                  class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 hover:bg-gray-300 rounded-lg transition-colors"
                >
                  Clear
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Connection ID -->
        <div class="mb-6">
          <div class="bg-white rounded-lg shadow-md border border-gray-200 p-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">
              Fivetran Connection ID(s)
            </label>
            <input
              type="text"
              x-model="connectionId"
              placeholder="Enter single connection ID or comma-separated list (e.g., abc123xyz or abc123xyz,def456uvw,ghi789rst)"
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 transition-colors input-focus"
            />
            <p class="mt-2 text-xs text-gray-500">
              <strong>Single:</strong> Enter one connection ID (e.g., <code class="bg-gray-100 px-1 rounded">abc123xyz</code>)<br>
              <strong>Multiple:</strong> Enter comma-separated connection IDs (e.g., <code class="bg-gray-100 px-1 rounded">abc123xyz,def456uvw,ghi789rst</code>)
            </p>
            <div x-show="connectionId" class="mt-2 text-xs" :class="isMultipleConnections ? 'text-blue-600' : 'text-gray-600'">
              <span x-show="isMultipleConnections" class="font-medium">
                ✓ Multiple connections detected (<span x-text="connectionIdList.length"></span> connection<span x-text="connectionIdList.length > 1 ? 's' : ''"></span>)
              </span>
              <span x-show="!isMultipleConnections" class="font-medium">
                ✓ Single connection detected
              </span>
            </div>
          </div>
        </div>

        <!-- Actions and Results Side by Side -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <!-- Actions Card -->
          <div class="bg-white rounded-lg shadow-md border border-gray-200 overflow-hidden card-hover">
            <div class="p-4 text-white" style="background-color: #306BEA;">
              <div class="flex items-center space-x-3">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                </svg>
                <h2 class="text-xl font-bold">Actions</h2>
              </div>
            </div>
            
            <div class="p-6 space-y-4">
              <!-- Get State Button -->
              <button
                @click="getState()"
                :disabled="!canPerformAction || loading"
                class="w-full text-white font-medium py-3 px-6 rounded-lg transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center hover:opacity-90"
                :style="(!canPerformAction || loading) ? 'background-color: #9CA3AF;' : 'background-color: #306BEA;'"
              >
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                </svg>
                <span x-show="!loading || actionType !== 'get'">
                  <span x-show="!isMultipleConnections">Get Current State</span>
                  <span x-show="isMultipleConnections">Get All States</span>
                </span>
                <span x-show="loading && actionType === 'get'" class="flex items-center space-x-2">
                  <span class="spinner"></span>
                  <span>Loading...</span>
                </span>
              </button>

              <!-- Update State Section -->
              <div class="border-t border-gray-200 pt-4">
                <h3 class="text-lg font-semibold text-gray-900 mb-3">Update State</h3>
                
                <div class="mb-4">
                  <label class="block text-sm font-medium text-gray-700 mb-2">
                    New State (JSON)
                  </label>
                  <textarea
                    x-model="newStateJson"
                    placeholder='{"cursor": "2025-03-06 20:20:20", "last_sync": "2025-01-15T10:30:00Z"}'
                    rows="6"
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 transition-colors input-focus font-mono text-sm"
                  ></textarea>
                  <p class="mt-1 text-xs text-gray-500">
                    Enter valid JSON to update the connection state.
                  </p>
                </div>

                <button
                  @click="updateState()"
                  :disabled="!canPerformAction || loading || !newStateJson"
                  class="w-full text-white font-medium py-3 px-6 rounded-lg transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center hover:opacity-90"
                  :style="(!canPerformAction || loading || !newStateJson) ? 'background-color: #9CA3AF;' : 'background-color: #306BEA;'"
                >
                  <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path>
                  </svg>
                  <span x-show="!loading || actionType !== 'update'">
                    <span x-show="!isMultipleConnections">Update State</span>
                    <span x-show="isMultipleConnections">Update All States</span>
                  </span>
                  <span x-show="loading && actionType === 'update'" class="flex items-center space-x-2">
                    <span class="spinner"></span>
                    <span>Updating...</span>
                  </span>
                </button>
              </div>
            </div>
          </div>

          <!-- Results Card -->
          <div class="bg-white rounded-lg shadow-md border border-gray-200 overflow-hidden card-hover">
            <div class="p-4 text-white flex items-center justify-between" style="background-color: #306BEA;">
              <div class="flex items-center space-x-3">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
                <h2 class="text-xl font-bold">Results</h2>
              </div>
              <button
                x-show="result"
                @click="result = null"
                class="text-white hover:opacity-80 transition-opacity"
              >
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                </svg>
              </button>
            </div>
            
            <div class="p-6" style="min-height: 400px;">
              <div x-show="!result" class="text-center py-12">
                <svg class="w-16 h-16 text-gray-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
                <p class="text-gray-500 text-lg">No results yet</p>
                <p class="text-gray-400 text-sm mt-2">Perform an action to see results here</p>
              </div>
              
              <div x-show="result" class="json-viewer rounded-lg p-4">
                <pre x-text="formatJSON(result)"></pre>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <script>
      function fivetranStateManager() {
        return {
          // State
          apiKey: '',
          apiSecret: '',
          connectionId: '',
          newStateJson: '',
          credentialsSaved: false,
          credentialsExpanded: false,
          loading: false,
          actionType: '',
          result: null,
          connectionError: '',
          successMessage: '',

          // Computed
          get canPerformAction() {
            return this.credentialsSaved && this.apiKey && this.apiSecret && this.connectionId;
          },

          get connectionIdList() {
            if (!this.connectionId) return [];
            return this.connectionId
              .split(',')
              .map(id => id.trim())
              .filter(id => id.length > 0);
          },

          get isMultipleConnections() {
            return this.connectionIdList.length > 1;
          },

          // Initialization
          init() {
            this.loadCredentials();
          },

          // Credential Management
          obfuscateValue(value) {
            if (!value || value.length < 4) return '••••';
            return value.substring(0, 2) + '•'.repeat(Math.min(value.length - 4, 20)) + value.substring(value.length - 2);
          },

          saveCredentials() {
            if (!this.apiKey || !this.apiSecret) {
              this.showError('Please enter both API key and secret');
              return;
            }

            // Store in sessionStorage (obfuscated for display)
            try {
              sessionStorage.setItem('ft_api_key', this.apiKey);
              sessionStorage.setItem('ft_api_secret', this.apiSecret);
              this.credentialsSaved = true;
              this.credentialsExpanded = false; // Collapse after saving
              this.showSuccess('Credentials saved for this session');
            } catch (error) {
              this.showError('Failed to save credentials: ' + error.message);
            }
          },

          loadCredentials() {
            try {
              const savedKey = sessionStorage.getItem('ft_api_key');
              const savedSecret = sessionStorage.getItem('ft_api_secret');
              
              if (savedKey && savedSecret) {
                this.apiKey = savedKey;
                this.apiSecret = savedSecret;
                this.credentialsSaved = true;
                this.credentialsExpanded = false; // Keep collapsed if credentials are saved
              }
            } catch (error) {
              console.error('Failed to load credentials:', error);
            }
          },

          clearCredentials() {
            try {
              sessionStorage.removeItem('ft_api_key');
              sessionStorage.removeItem('ft_api_secret');
              this.apiKey = '';
              this.apiSecret = '';
              this.credentialsSaved = false;
              this.result = null;
              this.showSuccess('Credentials cleared');
            } catch (error) {
              this.showError('Failed to clear credentials: ' + error.message);
            }
          },

          // API Calls
          async getState() {
            if (!this.canPerformAction) {
              this.showError('Please save credentials and enter a connection ID');
              return;
            }

            if (this.connectionIdList.length === 0) {
              this.showError('Please enter at least one connection ID');
              return;
            }

            this.loading = true;
            this.actionType = 'get';
            this.connectionError = '';
            this.result = null;

            try {
              let response;
              if (this.isMultipleConnections) {
                // Multiple connections - use /state/get-multiple
                response = await fetch('/state/get-multiple', {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json',
                  },
                  body: JSON.stringify({
                    api_key: this.apiKey,
                    api_secret: this.apiSecret,
                    connection_ids: this.connectionIdList,
                  }),
                });
              } else {
                // Single connection - use /state/get
                response = await fetch('/state/get', {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json',
                  },
                  body: JSON.stringify({
                    api_key: this.apiKey,
                    api_secret: this.apiSecret,
                    connection_id: this.connectionIdList[0],
                  }),
                });
              }

              if (!response.ok) {
                const errorData = await response.json().catch(() => ({ detail: 'Unknown error' }));
                throw new Error(errorData.detail || `HTTP ${response.status}`);
              }

              const data = await response.json();
              this.result = data;
              
              // Extract state and populate the update state textarea (only for single connection)
              if (!this.isMultipleConnections) {
                try {
                  let stateData = null;
                  
                  // Handle different response formats
                  if (data.data && data.data.state) {
                    // Format: {"code": "Success", "data": {"state": {...}}}
                    stateData = data.data.state;
                  } else if (data.state) {
                    // Format: {"state": {...}}
                    stateData = data.state;
                  } else if (data.data) {
                    // Format: {"data": {...}} where data itself is the state
                    stateData = data.data;
                  }
                  
                  if (stateData) {
                    // Format as {"state": {...}} for the update box
                    const formattedState = {
                      state: stateData
                    };
                    this.newStateJson = JSON.stringify(formattedState, null, 2);
                  }
                } catch (parseError) {
                  console.warn('Could not extract state for update box:', parseError);
                  // Don't show error to user, just log it
                }
              }
              
              const successMsg = this.isMultipleConnections 
                ? `State retrieved successfully for ${this.connectionIdList.length} connections`
                : 'State retrieved successfully';
              this.showSuccess(successMsg);
            } catch (error) {
              this.showError('Failed to get state: ' + error.message);
            } finally {
              this.loading = false;
              this.actionType = '';
            }
          },

          async updateState() {
            if (!this.canPerformAction) {
              this.showError('Please save credentials and enter a connection ID');
              return;
            }

            if (this.connectionIdList.length === 0) {
              this.showError('Please enter at least one connection ID');
              return;
            }

            if (!this.newStateJson) {
              this.showError('Please enter a new state (JSON)');
              return;
            }

            let newState;
            try {
              newState = JSON.parse(this.newStateJson);
              // If the JSON has a "state" key, extract it
              if (newState.state) {
                newState = newState.state;
              }
            } catch (error) {
              this.showError('Invalid JSON format: ' + error.message);
              return;
            }

            this.loading = true;
            this.actionType = 'update';
            this.connectionError = '';
            this.result = null;

            try {
              let response;
              if (this.isMultipleConnections) {
                // Multiple connections - use /state/update-multiple (all-or-nothing)
                response = await fetch('/state/update-multiple', {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json',
                  },
                  body: JSON.stringify({
                    api_key: this.apiKey,
                    api_secret: this.apiSecret,
                    connection_ids: this.connectionIdList,
                    new_state: newState,
                  }),
                });
              } else {
                // Single connection - use /state/update
                response = await fetch('/state/update', {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json',
                  },
                  body: JSON.stringify({
                    api_key: this.apiKey,
                    api_secret: this.apiSecret,
                    connection_id: this.connectionIdList[0],
                    new_state: newState,
                  }),
                });
              }

              if (!response.ok) {
                const errorData = await response.json().catch(() => ({ detail: 'Unknown error' }));
                throw new Error(errorData.detail || `HTTP ${response.status}`);
              }

              const data = await response.json();
              this.result = data;
              
              const successMsg = this.isMultipleConnections
                ? `State updated successfully for ${this.connectionIdList.length} connections (all-or-nothing)`
                : 'State updated successfully';
              this.showSuccess(successMsg);
            } catch (error) {
              this.showError('Failed to update state: ' + error.message);
            } finally {
              this.loading = false;
              this.actionType = '';
            }
          },

          // Utility Functions
          formatJSON(obj) {
            return JSON.stringify(obj, null, 2);
          },

          showError(message) {
            this.connectionError = message;
            this.successMessage = '';
            setTimeout(() => {
              if (this.connectionError === message) {
                this.connectionError = '';
              }
            }, 5000);
          },

          showSuccess(message) {
            this.successMessage = message;
            this.connectionError = '';
            setTimeout(() => {
              if (this.successMessage === message) {
                this.successMessage = '';
              }
            }, 3000);
          },
        };
      }
    </script>
  </body>
</html>
